<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AutoTrader Setup</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css" />
    <style>
      body {
        font-family: "IBM Plex Mono", monospace;
        color: var(--text);
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      form {
        background: var(--panel-bg);
        border: 1px solid var(--panel-border);
        padding: 32px;
        border-radius: 18px;
        box-shadow: 0 25px 50px rgba(0,0,0,0.45);
        width: min(420px, 90vw);
      }
      h1 { margin-top: 0; }
      label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 14px;
        font-size: 13px;
      }
      input {
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.12);
        padding: 10px;
        background: rgba(0,0,0,0.25);
        color: var(--text);
      }
      .info-card {
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.12);
        border-radius: 14px;
        padding: 14px 16px;
        margin-bottom: 20px;
      }
      .info-card code {
        background: rgba(0,0,0,0.35);
        padding: 4px 8px;
        border-radius: 8px;
      }
      .ip-row {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        margin: 8px 0;
      }
      .ip-row button {
        border: 1px solid rgba(255,255,255,0.2);
        background: transparent;
        color: #fff;
        border-radius: 8px;
        padding: 4px 12px;
        cursor: pointer;
      }
      button {
        width: 100%;
        padding: 12px;
        border-radius: 12px;
        border: none;
        background: linear-gradient(130deg,#b171ff,#7f53ff);
        color: #fff;
        font-weight: 600;
        cursor: pointer;
        margin-top: 12px;
      }
    </style>
  </head>
  <body>
    <form id="autotrader-form">
      <h1>AutoTrader Configuration</h1>
    <div class="info-card">
      <p><strong>Bybit Futures Endpoints</strong></p>
      <ul style="margin:8px 0 14px 18px;padding:0;color:#c9c4ff;font-size:13px;">
        <li>Live: <code>https://api.bybit.com</code></li>
        <li>Testnet: <code>https://api-testnet.bybit.com</code></li>
        <li>Demo: <code>https://api-demo.bybit.com</code></li>
      </ul>
      <p style="margin-top:10px;">Whitelist these IPs for your Bybit API key:</p>
      <div class="ip-row" style="flex-wrap:wrap;">
        <code id="whitelist-ip">Detecting...</code>
        <button type="button" id="copy-ip">Copy</button>
      </div>
      <small>The server IP above is what Bybit must allow. Add any additional deployment IPs you use.</small>
    </div>
      <label>Exchange Base URL
        <input name="base" type="text" value="https://api.bybit.com" readonly />
      </label>
      <label>Exchange
        <input type="text" value="Bybit" readonly />
      </label>
      <label>Environment
        <input type="text" value="Live" readonly />
      </label>
      <label>Account Type
        <select name="account_type">
          <option value="contract" selected>Futures (Contract)</option>
          <option value="unified">Futures (Unified)</option>
        </select>
      </label>
      <label>Margin Mode
        <select name="margin_mode">
          <option value="cross" selected>Cross</option>
          <option value="isolated">Isolated</option>
        </select>
      </label>
      <label>API Key
        <input name="api" type="text" required />
      </label>
      <label>API Secret
        <input name="secret" type="password" required />
      </label>
      <label>Max Equity % per Trade
        <input name="risk" type="number" step="0.001" value="0.02" required />
      </label>
      <label>Leverage (x)
        <input name="leverage" type="number" step="0.1" min="1" value="1" required />
      </label>
      <small id="exposure-hint" style="margin:-6px 0 10px;display:block;color:rgba(255,255,255,0.6);">
        Effective exposure: --
      </small>
      <label>Divergence Stop (%)</label>
      <input name="stop" type="number" step="0.1" value="3" required />
      <label>Divergence Target (%)</label>
      <input name="target" type="number" step="0.1" value="1.5" required />
      <button type="submit">Save & Return</button>
    </form>
    <button class="theme-switch theme-switch-floating" data-theme-toggle type="button">Theme</button>
    <script src="theme_toggle.js" defer></script>
    <script>
      const form = document.getElementById("autotrader-form");
    const baseInput = form.querySelector("input[name='base']");
    const accountSelect = form.querySelector("select[name='account_type']");
    const marginSelect = form.querySelector("select[name='margin_mode']");
    const apiInput = form.querySelector("input[name='api']");
    const secretInput = form.querySelector("input[name='secret']");
    const riskInput = form.querySelector("input[name='risk']");
    const leverageInput = form.querySelector("input[name='leverage']");
    const stopInput = form.querySelector("input[name='stop']");
    const targetInput = form.querySelector("input[name='target']");
    const ipLabel = document.getElementById("whitelist-ip");
    const copyIpBtn = document.getElementById("copy-ip");
    const exposureHint = document.getElementById("exposure-hint");

    const updateIp = (value) => {
      if (ipLabel) ipLabel.textContent = value || "Unavailable";
    };

    if (copyIpBtn) {
      copyIpBtn.addEventListener("click", () => {
        if (!ipLabel) return;
        const text = ipLabel.textContent || "";
        navigator.clipboard?.writeText(text);
        alert(`Copied ${text} to clipboard`);
      });
    }

    fetch("/autotrader/public_ip")
      .then((r) => {
        if (!r.ok) throw new Error("server");
        return r.json();
      })
      .then((data) => updateIp(data.ip || "Unavailable"))
      .catch(() => {
        fetch("https://api.ipify.org?format=json")
          .then((res) => res.json())
          .then((data) => updateIp(data.ip || "Unavailable"))
          .catch(() => updateIp("Unavailable"));
      });

    function syncBaseUrl() {
      if (!baseInput) return;
      baseInput.value = "https://api.bybit.com";
    }
    // Account type may influence future logic; keep base fixed
    accountSelect.addEventListener("change", syncBaseUrl);

    function loadConfig() {
      try {
        const raw = localStorage.getItem("autotraderConfig");
        if (!raw) return;
        const cfg = JSON.parse(raw);
        if (cfg.account_type) accountSelect.value = cfg.account_type;
        if (cfg.margin_mode) marginSelect.value = cfg.margin_mode;
        if (cfg.base) baseInput.value = cfg.base;
        if (cfg.api) apiInput.value = cfg.api;
        if (cfg.secret) secretInput.value = cfg.secret;
        if (cfg.max_equity_pct) riskInput.value = cfg.max_equity_pct;
        if (cfg.leverage) leverageInput.value = cfg.leverage;
        if (cfg.stop_pct) stopInput.value = cfg.stop_pct;
        if (cfg.target_pct) targetInput.value = cfg.target_pct;
      } catch (err) {
        console.error("Failed to load autotrader config", err);
      }
    }

    function normalizePct(value) {
      const num = Number(value);
      if (!Number.isFinite(num)) return 0;
      return num > 1 ? num / 100 : num;
    }

    function updateExposure() {
      if (!exposureHint) return;
      const pct = normalizePct(riskInput?.value || 0);
      const levRaw = Number(leverageInput?.value || 1);
      const lev = Number.isFinite(levRaw) && levRaw > 0 ? levRaw : 1;
      const basePct = (pct * 100).toFixed(2);
      const effPct = (pct * lev * 100).toFixed(2);
      exposureHint.textContent = `Effective exposure: ${basePct}% x ${lev} = ${effPct}% of equity`;
    }

    loadConfig();
    syncBaseUrl();
    updateExposure();

    riskInput?.addEventListener("input", updateExposure);
    leverageInput?.addEventListener("input", updateExposure);

    form.addEventListener("submit", (e) => {
        e.preventDefault();
        const data = new FormData(e.currentTarget);
        const payload = {
          base: data.get("base"),
          exchange: "bybit",
          environment: "live",
          account_type: data.get("account_type"),
          margin_mode: data.get("margin_mode"),
          api: data.get("api"),
          secret: data.get("secret"),
          max_equity_pct: Number(data.get("risk")),
          leverage: Number(data.get("leverage")) || 1,
          stop_pct: Number(data.get("stop")),
          target_pct: Number(data.get("target")),
          updated_at: new Date().toISOString(),
        };
        localStorage.setItem("autotraderConfig", JSON.stringify(payload));
        alert("AutoTrader configuration saved.");
        window.location.href = "live_mystrix+.html";
      });
    </script>
  </body>
</html>

